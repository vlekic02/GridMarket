name: GridMarket GCP deploy

on:
  push:
    branches:
      - "GM-24-Deploy-Application-Service-to-Compute-Engine"
    #pull_request:
    #branches:
    #  - 'main'
    #types:
    #  - 'closed'

jobs:
  deploy:
    #if: ${{ github.event.pull_request.merged == true }}
    name: Deploy
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.6

      - name: Detect changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            application:
              - 'application-service/**'

      - name: Setup Java
        uses: actions/setup-java@v4.2.1
        with:
          distribution: 'temurin'
          java-version: 21
          cache: 'gradle'

      - name: Setup local dependencies
        run: |
          cd jackson-jsonapi/
          chmod +x ./gradlew
          ./gradlew publishToMavenLocal --no-daemon
          cd ../test-utils/
          chmod +x ./gradlew
          ./gradlew publishToMavenLocal --no-daemon

      - name: Build Application Service Image
        #if: steps.filter.outputs.application == 'true'
        id: application-image
        run: |
          cd application-service/
          chmod +x ./gradlew
          VERSION=$(./gradlew printVersion -q)
          ./gradlew bootBuildImage --imageName=${{ vars.REPOSITORY_URL }}/${{ vars.PROJECT_ID }}/gridmarket/application-service:$VERSION
          echo "image-name=${{ vars.REPOSITORY_URL }}/${{ vars.PROJECT_ID }}/gridmarket/application-service:$VERSION" >> $GITHUB_OUTPUT

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2.1.3
        #if: fromJson(steps.filter.outputs.changes)[0] != null
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Setup CloudSDK
        #if: fromJson(steps.filter.outputs.changes)[0] != null
        uses: google-github-actions/setup-gcloud@v2.1.0
        with:
          project_id: ${{ vars.PROJECT_ID }}

      - name: Configure docker client for GCP
        #if: fromJson(steps.filter.outputs.changes)[0] != null
        run: |
          gcloud auth configure-docker ${{ vars.REPOSITORY_URL }}

      - name: Push application image to registry
        #if: steps.filter.outputs.application == 'true'
        run: |
          docker push ${{ steps.application-image.outputs.image-name }}

      - name: Deploy application service
        #if: steps.filter.outputs.application == 'true'
        run: |
          gcloud compute instances update-container gm-application-service \
              --container-image=${{ steps.application-image.outputs.image-name }}